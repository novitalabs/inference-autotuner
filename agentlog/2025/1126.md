

## Mini-milestone: Frontend API Proxy and Environment Configuration

> Configure the frontend development server to proxy backend APIs and unify environment configuration.

<details>
<summary>Resolved CORS issues by configuring Vite proxy and creating unified .env file</summary>

**User Request:**
Configure the frontend to properly proxy backend API requests to avoid CORS issues when accessing through port-forwarded addresses.

**Problem Analysis:**

1. **Initial CORS Error:**
   - User accessing frontend via port 54890 (port-forwarded)
   - Requests to `http://localhost:8000/api/...` blocked by CORS
   - Multiple API service files had hardcoded `http://localhost:8000`

2. **Double `/api/api/` Path Issue:**
   - Frontend `.env` had `VITE_API_URL=http://localhost:8000/api`
   - Service files added `/api` prefix again
   - Result: `http://localhost:8000/api/api/dashboard/...` → 404 errors

3. **Fragmented Configuration:**
   - Backend used `/root/work/inference-autotuner/.env`
   - Frontend had separate `frontend/.env`
   - Potential for configuration drift

**Solution Implemented:**

**1. Fixed API URL Configuration:**
   - Updated all service files to use relative URLs:
     - `dashboardApi.ts`: `API_BASE_URL = import.meta.env.VITE_API_URL || ''`
     - `presetService.ts`: `API_BASE = import.meta.env.VITE_API_URL || ''`
     - `runtimeParamsService.ts`: `API_BASE = import.meta.env.VITE_API_URL || ''`
     - `api.ts`: `baseURL = import.meta.env.VITE_API_URL || '/api'`

**2. Configured Backend CORS:**
   - Updated `src/web/config.py`: `cors_origins: list = ["*"]`
   - Allows all origins in development (can be restricted in production)
   - Verified CORS headers working with `curl` test

**3. Fixed Environment Variables:**
   - Set `VITE_API_URL=` (empty) in `.env` file
   - All API calls now use relative URLs (e.g., `/api/dashboard/...`)
   - Works with both Vite proxy and port forwarding

**4. Vite Configuration:**
   - Confirmed proxy configured in `vite.config.ts`:
     ```typescript
     server: {
       port: 5173,
       proxy: {
         '/api': {
           target: 'http://localhost:8000',
           changeOrigin: true,
         },
       },
     }
     ```

**5. Unified Environment Configuration:**
   - Created single `.env` at project root with both backend and frontend config
   - Updated `vite.config.ts` to load from parent directory: `envDir: '../'`
   - Removed `frontend/.env` to avoid duplication
   - Updated `.env.example` to document all variables

**Files Changed:**
- `src/web/config.py` - CORS origins set to `["*"]`
- `frontend/src/services/dashboardApi.ts` - Use relative URLs
- `frontend/src/services/presetService.ts` - Use relative URLs
- `frontend/src/services/runtimeParamsService.ts` - Use relative URLs
- `frontend/src/services/api.ts` - Use relative URLs
- `frontend/vite.config.ts` - Load .env from parent directory
- `frontend/.env` - Removed (deprecated)
- `.env` - Unified configuration file with backend + frontend variables
- `.env.example` - Updated template with all options
- `frontend/.env.example` - Marked as deprecated

**Database Setup:**
- Created database directory: `~/.local/share/inference-autotuner/`
- Fixed database path in `.env` for user `claude`
- Backend successfully initialized database with tables

**Testing:**
- ✅ Backend health check: `http://localhost:8000/health`
- ✅ Vite proxy working: `http://localhost:5173/api/dashboard/worker-status`
- ✅ CORS preflight verified with curl OPTIONS request
- ✅ Frontend dev server running on port 5173
- ✅ Backend API running on port 8000
- ✅ ARQ worker running in background

**Final Configuration:**

```
Project Structure:
/root/work/inference-autotuner/
├── .env                    # ✅ Unified config (backend + frontend)
├── .env.example           # ✅ Template with all options
├── frontend/
│   ├── .env.example       # Deprecated (points to root)
│   └── vite.config.ts     # Configured to use root .env
```

**Environment Variables:**
```bash
# Backend
DATABASE_URL=sqlite+aiosqlite:////home/claude/.local/share/inference-autotuner/autotuner.db
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# Frontend (empty = relative URLs)
VITE_API_URL=
```

**How It Works:**
- **Direct access (localhost:5173):** Vite proxy forwards `/api/*` → `http://localhost:8000/api/*`
- **Port-forwarded access (port 54890):** Relative URLs go to same host, needs reverse proxy or separate backend forwarding
- **CORS enabled:** Backend accepts requests from all origins

**Key Learnings:**

1. **Vite Proxy Limitations:**
   - Proxy only works when accessing the actual Vite dev server
   - Port forwarding bypasses the proxy unless both frontend and backend are forwarded
   - Solution: Use relative URLs + backend CORS for maximum flexibility

2. **Environment Variable Precedence:**
   - Vite loads `.env` from project directory by default
   - Can override with `envDir` option in config
   - Empty string in `.env` allows proper fallback to default values

3. **API Path Structure:**
   - Backend routes include `/api` prefix (e.g., `prefix="/api/dashboard"`)
   - Frontend services should NOT add additional `/api` prefix
   - Careful coordination needed between baseURL and route paths

4. **Unified Configuration Benefits:**
   - Single source of truth for all environment variables
   - Easier maintenance and deployment
   - Prevents configuration drift between frontend and backend

**Status:** ✅ Complete - Frontend properly configured with unified environment and working CORS

</details>

---

