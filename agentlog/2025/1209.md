# 2025-12-09 Development Diary

## Agent Chat Bug Fixes and Improvements

### Summary of Today's Work

Based on git commits from today:
- `216d4a9` - fixed agent tool calling issues
- `eca03a3` - redesigned tool card
- `ceab884` - Fixed chat context when error occurred
- `af89f4c` - fixed streaming text overlap
- `6a59dc2` - try to fix calendar workflow
- `459560f` - fixed tool card disappear bug
- `e78454b` - fixed tool cards logic

---

## 1. Fix Duplicate Tool Calling and Message Order Issues

> Fix duplicate tool calling display and message order reversal issues in agent chat.

<details>
<summary>Agent Response</summary>

### Issues Fixed

#### 1.1 Message Order Reversal
**Problem**: User and assistant message bubbles were reversed after message transmission ended.

**Root Cause**: In `chatStorage.ts`, the sorting logic was extracting timestamps from message IDs in format `sessionId-timestamp-random`, but backend IDs are numeric, causing sort failures.

**Fix**: Changed to use `created_at` timestamp for sorting with format normalization:
- Frontend timestamps: `2024-01-15T10:30:00.000Z` (with Z suffix)
- Backend timestamps: `2024-01-15T10:30:00.123456` (without Z)
- Added `normalizeTimestamp()` function to handle both formats by appending 'Z' if missing.

#### 1.2 Duplicate Tool Calls in UI
**Problem**: Tool cards appeared multiple times during streaming.

**Root Cause**: React StrictMode double-invokes state update callbacks, causing `setStreamingIterations(prev => ...)` to run twice.

**Fix**: Changed from callback pattern to using `streamingIterationsRef.current` as single source of truth:
- Read from ref first
- Update ref
- Then sync to state with `setStreamingIterations(updated)`
- Added deduplication checks for tool IDs

Handlers updated: `iteration_start`, `iteration_complete`, `content`, `tool_start`, `tool_results`, `error`.

#### 1.3 LLM Content Repetition
**Problem**: Claude was repeating the same content multiple times in a row.

**Root Cause**: In `llm_client.py`, Claude provider skips `role: tool` messages (line 513-516: "Skip tool results - they're not properly formatted for Anthropic API"). This meant Claude couldn't see tool execution results, causing it to repeat itself.

**Fix**: In `agent.py`, changed tool results handling:
- Before: Added `role: tool` messages (which get skipped)
- After: Added `role: user` message with tool results summary:
```python
llm_messages.append({
    "role": "user",
    "content": "Tool execution results:\n\n" + "\n\n---\n\n".join(tool_results_summary) +
              "\n\nPlease continue based on these results..."
})
```

### Files Modified
- `frontend/src/services/chatStorage.ts` - Message sorting using `created_at` timestamp
- `frontend/src/pages/AgentChat.tsx` - SSE event handling with useRef pattern
- `frontend/src/services/agentApi.ts` - Debug logging (added then removed)
- `src/web/routes/agent.py` - Tool results as user message for Claude compatibility

### Debug Logging Cleanup
Removed all debug `console.log` statements added during troubleshooting:
- `[Message Order]` logs
- `[SSE]` event tracking logs
- `[agentApi]` event counter

Kept appropriate logging:
- `console.error` for actual errors
- `console.debug` for deduplication messages

</details>

---

## 2. Fix Timestamp Timezone Display

> Fix incorrect timezone display for assistant messages. Note: `.env` has `TIMEZONE=Asia/Shanghai` configured.

<details>
<summary>Agent Response</summary>

### Problem
Assistant message timestamps were displayed in wrong timezone (8 hours behind expected time). Backend returns UTC timestamps without 'Z' suffix (e.g., `2025-12-09T12:30:25.030388`), which JavaScript interpreted incorrectly.

### Root Cause
1. Backend returns UTC timestamps without timezone indicator
2. The original regex `/[Z+-]/` was meant to detect timezone indicators, but it matched the `-` in date separators (e.g., `2025-12-09`), causing the function to skip adding 'Z' suffix
3. Without proper UTC indication, JavaScript's `new Date()` interprets timestamps as local time

### Fix
Fixed `parseTimestamp()` function to properly detect timezone indicators only at the **end** of the timestamp:

```typescript
function parseTimestamp(timestamp: string): Date {
    if (!timestamp) return new Date();
    // Check if timestamp already has timezone indicator at the END
    // Z suffix, or +HH:MM / -HH:MM offset (but not the dashes in date part)
    const hasTimezone = timestamp.endsWith('Z') ||
                        /[+-]\d{2}:\d{2}$/.test(timestamp) ||
                        /[+-]\d{4}$/.test(timestamp);
    const normalized = hasTimezone ? timestamp : timestamp + "Z";
    return new Date(normalized);
}
```

Also updated `MessageBubble` component to use `timezone` from `TimezoneContext` for formatting:

```typescript
const { timezone } = useTimezone();
const displayTime = (ts: string) => {
    const date = parseTimestamp(ts);
    return date.toLocaleTimeString('en-US', {
        timeZone: timezone,
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
};
```

### Result
- UTC timestamp `12:30:25` now correctly displays as `20:30` in Shanghai timezone (UTC+8)
- Timezone is dynamically fetched from `/api/system/info` via `TimezoneContext`

### Files Modified
- `frontend/src/pages/AgentChat.tsx` - Fixed `parseTimestamp()` regex, updated `MessageBubble` to use context timezone

</details>
